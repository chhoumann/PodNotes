name: Release

on:
  workflow_dispatch:
    inputs:
      dryRun:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean
  repository_dispatch:
    types: [release-trigger]

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22]
    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Setup Deno
        uses: denolib/setup-deno@v2
        with:
          deno-version: v1.x

      - name: Validate trigger
        id: validate
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "valid=true" >> "$GITHUB_OUTPUT"
          else
            echo "valid=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.validate.outputs.valid == 'true'
        run: npm install

      - name: Build
        if: steps.validate.outputs.valid == 'true'
        run: npm run build --if-present

      - name: Run tests
        if: steps.validate.outputs.valid == 'true'
        run: npm run test

      - name: Release
        id: release
        if: steps.validate.outputs.valid == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dryRun || 'false' }}
        run: |
          EXTRA_ARGS=""

          if [ "$DRY_RUN" = "true" ]; then
            echo "Running in dry-run mode"
            EXTRA_ARGS="--dry-run"
          fi

          npx semantic-release $EXTRA_ARGS
          EXIT_CODE=$?

          if [ "$DRY_RUN" != "true" ] && [ $EXIT_CODE -eq 0 ]; then
            echo "released=true" >> "$GITHUB_OUTPUT"
          else
            echo "released=false" >> "$GITHUB_OUTPUT"
          fi

          exit $EXIT_CODE

      - name: Extract version
        id: extract-version
        if: steps.release.outputs.released == 'true'
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
